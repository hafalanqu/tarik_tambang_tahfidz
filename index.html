<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tarik Tambang Sambung Ayat Online</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #e0f2fe;
        }
        .quran-font {
            font-family: 'Amiri', serif;
            line-height: 2.0;
        }
        
        /* Container animasi gerak */
        #tug-container {
            position: absolute;
            width: 100%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
            /* top: -2%;  <-- Dihapus, tali yang akan dinaikkan */
        }

        .rope-line {
            height: 8px;
            background: repeating-linear-gradient(
                45deg,
                #854d0e,
                #854d0e 6px,
                #713f12 6px,
                #713f12 12px
            );
            border-radius: 4px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            z-index: 50; /* Tali di DEPAN orang */
            position: relative;
        }

        .knot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 26px;
            height: 26px;
            background-color: #facc15;
            border: 3px solid #854d0e;
            border-radius: 50%;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        
        .character {
            transition: transform 0.2s;
            z-index: 40; /* Orang di BELAKANG tali */
        }
        
        /* Animasi Tarik */
        .pulling-left { animation: pullLeft 0.5s infinite; }
        .pulling-right { animation: pullRight 0.5s infinite; }
        
        @keyframes pullLeft {
            0% { transform: translateX(0) rotate(0deg); }
            50% { transform: translateX(-5px) rotate(-5deg); }
            100% { transform: translateX(0) rotate(0deg); }
        }
        @keyframes pullRight {
            0% { transform: scaleX(-1) translateX(0) rotate(0deg); }
            50% { transform: scaleX(-1) translateX(-5px) rotate(-5deg); }
            100% { transform: scaleX(-1) translateX(0) rotate(0deg); }
        }

        /* Penanda Tengah Layar */
        .center-line {
            position: absolute;
            top: 10%;
            bottom: 10%;
            left: 50%;
            width: 2px; 
            border-left: 2px dashed rgba(148, 163, 184, 0.4); 
            z-index: 0;
            transform: translateX(-50%);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden select-none bg-sky-50">

    <!-- Overlay FIXED (Fullscreen) -->
    <div id="main-overlay" class="fixed inset-0 z-[100] bg-slate-900/95 flex flex-col items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300 overflow-y-auto">
        
        <!-- Loading State -->
        <div id="loading-state" class="hidden text-center">
            <div class="animate-spin text-5xl text-green-500 mb-4 mx-auto"><i class="fas fa-circle-notch"></i></div>
            <h2 class="text-white text-xl font-bold">Menyiapkan Gelanggang...</h2>
            <p class="text-gray-400 text-sm mt-2">Mengambil data ayat...</p>
        </div>

        <!-- Start State & Settings -->
        <div id="start-state" class="w-full max-w-lg bg-white rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 text-center">
                <div class="text-5xl mb-2">üïå</div>
                <h1 class="text-2xl md:text-3xl font-black text-white tracking-wide">SAMBUNG AYAT</h1>
                <p class="text-green-100 text-sm">Uji hafalanmu dalam duel Tarik Tambang!</p>
            </div>

            <!-- Body Settings -->
            <div class="p-6 space-y-6">
                
                <!-- Mode Main -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider">Mode Permainan</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectMode('single')" id="mode-btn-single" class="py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-robot text-xl"></i> Lawan Bot
                        </button>
                        <button onclick="selectMode('multi')" id="mode-btn-multi" class="py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1">
                            <i class="fas fa-user-friends text-xl"></i> 2 Pemain
                        </button>
                    </div>
                </div>

                <!-- Filter Ayat -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2 uppercase tracking-wider">Rentang Hafalan</label>
                    
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 mb-4">
                        <button onclick="switchFilterTab('surah')" id="tab-surah" class="flex-1 py-2 text-sm font-bold text-green-600 border-b-2 border-green-600 transition-colors">Per Surat</button>
                        <button onclick="switchFilterTab('juz')" id="tab-juz" class="flex-1 py-2 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">Per Juz</button>
                    </div>

                    <!-- Content Surah -->
                    <div id="filter-content-surah" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Dari Surat:</span>
                                <select id="start-surah" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none">
                                    <option>Loading...</option>
                                </select>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Sampai Surat:</span>
                                <select id="end-surah" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none">
                                    <option>Loading...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Content Juz -->
                    <div id="filter-content-juz" class="space-y-3 hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Dari Juz:</span>
                                <select id="start-juz" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none">
                                    <!-- JS will populate 1-30 -->
                                </select>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Sampai Juz:</span>
                                <select id="end-juz" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-green-500 outline-none">
                                    <!-- JS will populate 1-30 -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Start Button -->
                <button onclick="initializeAndStart()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 text-lg flex items-center justify-center gap-2">
                    MULAI MAIN <i class="fas fa-play"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay Pemenang -->
    <div id="winner-overlay" class="hidden fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center p-4 backdrop-blur-md">
        <h2 class="text-gray-400 text-sm font-bold uppercase tracking-[0.3em] mb-4">Pemenang</h2>
        <div id="winner-badge" class="text-8xl mb-6 animate-pulse">üèÜ</div>
        <h1 id="winner-name" class="text-4xl md:text-5xl font-black text-yellow-400 mb-10 text-center drop-shadow-lg">TIM BIRU</h1>
        <button onclick="resetGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-10 rounded-full shadow-xl transition transform hover:scale-105 active:scale-95">
            Main Lagi <i class="fas fa-redo ml-2"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm p-2 z-50 flex-none border-b border-slate-100 relative">
        <div class="container mx-auto flex justify-center items-center relative">
            <div class="flex items-center gap-2">
                <div class="bg-green-50 p-1.5 rounded-lg border border-green-100">
                    <i class="fas fa-quran text-green-600 text-base"></i>
                </div>
                <h1 class="text-sm font-bold text-slate-700">Tarik Tambang Ayat</h1>
            </div>
            <div class="absolute right-0 top-1/2 -translate-y-1/2">
                <span id="active-mode-badge" class="bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded border border-slate-200 uppercase tracking-wider">
                    VS BOT
                </span>
            </div>
        </div>
    </header>

    <!-- Layout 3 Kolom -->
    <main class="flex-grow flex flex-row w-full overflow-hidden bg-white relative">
        
        <!-- 1. Panel Kiri -->
        <!-- Background lebih berwarna (bg-blue-200) -->
        <div id="panel-left" class="w-[28%] md:w-[25%] border-r border-gray-200 flex flex-col h-full transition-colors duration-300 bg-blue-200 z-20 relative shadow-lg">
            <!-- Header background lebih gelap (bg-blue-300) -->
            <div class="p-2 text-center border-b border-blue-300 bg-blue-300 backdrop-blur shadow-sm">
                <span class="text-[10px] md:text-xs font-extrabold text-blue-600 uppercase bg-blue-100 px-2 py-1 rounded-full tracking-wider">Tim Santri</span>
                <div id="q-surah-left" class="text-[10px] text-gray-600 mt-1 font-medium opacity-0">-</div>
            </div>
            <div class="flex-grow flex flex-col p-2 min-h-0 overflow-y-auto custom-scrollbar">
                <div class="flex-grow flex items-center justify-center py-2">
                    <!-- Ukuran font soal dikecilkan: text-lg md:text-xl -> text-base md:text-lg -->
                    <p id="q-text-left" class="quran-font text-base md:text-lg text-center text-slate-800 leading-[2.0] drop-shadow-sm" dir="rtl">...</p>
                </div>
                <div id="options-left" class="grid grid-cols-1 gap-2 mt-auto pb-2"></div>
            </div>
        </div>

        <!-- 2. Panel Tengah (Arena Visual) -->
        <div class="flex-grow relative bg-sky-100 overflow-hidden z-10 shadow-inner border-x-2 border-white/50">
            <div class="absolute top-4 left-6 text-white/70 text-5xl opacity-80"><i class="fas fa-cloud"></i></div>
            <div class="absolute top-10 right-12 text-white/60 text-3xl opacity-60"><i class="fas fa-cloud"></i></div>
            <div class="center-line"></div>

            <div id="tug-container" class="flex items-center justify-center h-full w-full">
                <!-- Orang Kiri -->
                <div id="char-left" class="character absolute left-[2%] md:left-[15%] bottom-[50%] md:bottom-[48%]">
                    <svg width="100" height="100" viewBox="0 0 100 100" class="drop-shadow-lg transform scale-90 md:scale-100">
                        <path d="M35 75 L35 98 L45 98 L45 75 Z" fill="#1e3a8a" />
                        <path d="M55 75 L55 98 L65 98 L65 75 Z" fill="#1e3a8a" />
                        <rect x="30" y="45" width="40" height="35" rx="4" fill="#2563eb" />
                        <circle cx="50" cy="32" r="15" fill="#fcd34d" />
                        <path d="M34 18 L66 18 L66 30 L34 30 Z" fill="#f1f5f9" />
                        <ellipse cx="50" cy="18" rx="16" ry="3" fill="#e2e8f0" />
                        <circle cx="54" cy="34" r="2" fill="#1e293b" />
                        <circle cx="60" cy="34" r="2" fill="#1e293b" />
                        <path d="M30 50 Q20 55 25 60" stroke="#2563eb" stroke-width="8" stroke-linecap="round" fill="none" />
                        <circle cx="25" cy="60" r="5" fill="#fcd34d" />
                        <path d="M50 52 L90 58" stroke="#2563eb" stroke-width="8" stroke-linecap="round" />
                        <circle cx="90" cy="58" r="6" fill="#fcd34d" stroke="#d97706" stroke-width="1"/>
                    </svg>
                </div>
                <!-- Tali -->
                <!-- Ditambahkan style="top: -3%;" untuk menaikkan tali -->
                <div class="relative w-[75%] md:w-[60%] flex items-center justify-center" style="top: -5%;">
                    <div class="rope-line w-full"></div>
                    <div id="rope-knot" class="knot"><i class="fas fa-flag text-red-600 text-xs"></i></div>
                </div>
                <!-- Orang Kanan -->
                <div id="char-right" class="character absolute right-[2%] md:right-[15%] bottom-[50%] md:bottom-[48%] scale-x-[-1]">
                    <svg width="100" height="100" viewBox="0 0 100 100" class="drop-shadow-lg transform scale-90 md:scale-100">
                        <path d="M35 75 L35 98 L45 98 L45 75 Z" fill="#7f1d1d" />
                        <path d="M55 75 L55 98 L65 98 L65 75 Z" fill="#7f1d1d" />
                        <rect x="30" y="45" width="40" height="35" rx="4" fill="#dc2626" />
                        <circle cx="50" cy="32" r="15" fill="#fcd34d" />
                        <path d="M34 14 L66 16 L66 30 L34 30 Z" fill="#1f2937" />
                        <ellipse cx="50" cy="15" rx="16" ry="3" fill="#374151" />
                        <circle cx="54" cy="34" r="2" fill="#1e293b" />
                        <circle cx="60" cy="34" r="2" fill="#1e293b" />
                        <path d="M30 50 Q20 55 25 60" stroke="#dc2626" stroke-width="8" stroke-linecap="round" fill="none" />
                        <circle cx="25" cy="60" r="5" fill="#fcd34d" />
                        <path d="M50 52 L90 58" stroke="#dc2626" stroke-width="8" stroke-linecap="round" />
                        <circle cx="90" cy="58" r="6" fill="#fcd34d" stroke="#b45309" stroke-width="1"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 3. Panel Kanan -->
        <!-- Background lebih berwarna (bg-red-200) -->
        <div id="panel-right" class="w-[28%] md:w-[25%] border-l border-gray-200 flex flex-col h-full transition-colors duration-300 bg-red-200 z-20 relative shadow-lg">
            <div id="bot-overlay" class="hidden absolute inset-0 bg-white/60 z-30 flex items-start justify-center pt-10 backdrop-blur-[1px]">
                <div class="bg-slate-800 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg animate-pulse border border-slate-600 flex items-center gap-1">
                    <i class="fas fa-robot text-red-400"></i> Bot...
                </div>
            </div>
            <!-- Header background lebih gelap (bg-red-300) -->
            <div class="p-2 text-center border-b border-red-300 bg-red-300 backdrop-blur shadow-sm">
                <span class="text-[10px] md:text-xs font-extrabold text-red-600 uppercase bg-red-100 px-2 py-1 rounded-full tracking-wider">Tim Nasional</span>
                <div id="q-surah-right" class="text-[10px] text-gray-600 mt-1 font-medium opacity-0">-</div>
            </div>
            <div class="flex-grow flex flex-col p-2 min-h-0 overflow-y-auto custom-scrollbar">
                <div class="flex-grow flex items-center justify-center py-2">
                    <!-- Ukuran font soal dikecilkan: text-lg md:text-xl -> text-base md:text-lg -->
                    <p id="q-text-right" class="quran-font text-base md:text-lg text-center text-slate-800 leading-[2.0] drop-shadow-sm" dir="rtl">...</p>
                </div>
                <div id="options-right" class="grid grid-cols-1 gap-2 mt-auto pb-2"></div>
            </div>
        </div>
    </main>

<script>
// --- GAME CONFIG & STATE ---
let gameMode = 'single'; 
let ropePosition = 50; 
let isGameActive = false;
let botInterval = null;
let cachedSurahData = {};
let activeSurahPool = []; // Array of IDs that can be played

// MAPPING JUZ START (Approximation: First surah of each Juz)
const juzStartSurah = {
    1: 1, 2: 2, 3: 3, 4: 3, 5: 4, 6: 4, 7: 5, 8: 6, 9: 7, 10: 8, 
    11: 9, 12: 11, 13: 12, 14: 15, 15: 17, 16: 18, 17: 21, 18: 23, 19: 25, 20: 27, 
    21: 29, 22: 33, 23: 36, 24: 39, 25: 41, 26: 46, 27: 51, 28: 58, 29: 67, 30: 78
};
// We need end mapping too to cover the whole juz range roughly
const juzEndSurah = {
    1: 2, 2: 2, 3: 3, 4: 4, 5: 4, 6: 5, 7: 6, 8: 7, 9: 8, 10: 9,
    11: 11, 12: 12, 13: 14, 14: 16, 15: 18, 16: 20, 17: 22, 18: 25, 19: 27, 20: 29,
    21: 33, 22: 36, 23: 39, 24: 41, 25: 45, 26: 51, 27: 57, 28: 66, 29: 77, 30: 114
};

// --- DOM ELEMENTS ---
const tugContainer = document.getElementById('tug-container');
const charLeft = document.getElementById('char-left');
const charRight = document.getElementById('char-right');
const panelLeft = document.getElementById('panel-left');
const panelRight = document.getElementById('panel-right');
const mainOverlay = document.getElementById('main-overlay');
const loadingState = document.getElementById('loading-state');
const startState = document.getElementById('start-state');
const btnModeSingle = document.getElementById('mode-btn-single');
const btnModeMulti = document.getElementById('mode-btn-multi');
const badgeMode = document.getElementById('active-mode-badge');

// Settings DOM
const startSurahSel = document.getElementById('start-surah');
const endSurahSel = document.getElementById('end-surah');
const startJuzSel = document.getElementById('start-juz');
const endJuzSel = document.getElementById('end-juz');

// --- INITIAL SETUP ---

window.onload = async () => {
    // Init Default Mode Button Style
    selectMode('single');
    
    // Populate Dropdowns
    await populateSettings();
};

async function populateSettings() {
    // 1. Populate Juz Selectors (Static)
    for(let i=1; i<=30; i++) {
        const opt1 = new Option(`Juz ${i}`, i);
        const opt2 = new Option(`Juz ${i}`, i);
        startJuzSel.add(opt1);
        endJuzSel.add(opt2);
    }
    startJuzSel.value = 30; // Default Juz 30
    endJuzSel.value = 30;

    // 2. Fetch Surah List for Dropdowns
    try {
        const response = await fetch('https://equran.id/api/v2/surat');
        const json = await response.json();
        const surahs = json.data; // Array of 114 surah objects

        startSurahSel.innerHTML = '';
        endSurahSel.innerHTML = '';

        surahs.forEach(s => {
            const label = `${s.nomor}. ${s.namaLatin}`;
            startSurahSel.add(new Option(label, s.nomor));
            endSurahSel.add(new Option(label, s.nomor));
        });

        // Default to Juz 30 range (Surah 78 - 114)
        startSurahSel.value = 78; 
        endSurahSel.value = 114;

    } catch (e) {
        console.error("Failed to load surah list", e);
        startSurahSel.innerHTML = '<option>Gagal memuat</option>';
    }
}

function selectMode(mode) {
    gameMode = mode;
    const activeClass = "bg-green-100 border-green-600 text-green-700 ring-2 ring-green-400 shadow-md";
    const inactiveClass = "bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100";

    if (mode === 'single') {
        btnModeSingle.className = `py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1 ${activeClass}`;
        btnModeMulti.className = `py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1 ${inactiveClass}`;
        badgeMode.innerText = "VS BOT";
    } else {
        btnModeSingle.className = `py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1 ${inactiveClass}`;
        btnModeMulti.className = `py-3 rounded-xl text-sm font-bold transition-all border-2 flex flex-col items-center justify-center gap-1 ${activeClass}`;
        badgeMode.innerText = "2 PLAYER";
    }
}

let filterMode = 'surah'; // 'surah' or 'juz'

function switchFilterTab(mode) {
    filterMode = mode;
    const activeTabClass = "text-green-600 border-green-600";
    const inactiveTabClass = "text-gray-400 border-transparent hover:text-gray-600";

    const tabSurah = document.getElementById('tab-surah');
    const tabJuz = document.getElementById('tab-juz');
    const contentSurah = document.getElementById('filter-content-surah');
    const contentJuz = document.getElementById('filter-content-juz');

    if(mode === 'surah') {
        tabSurah.className = `flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${activeTabClass}`;
        tabJuz.className = `flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${inactiveTabClass}`;
        contentSurah.classList.remove('hidden');
        contentJuz.classList.add('hidden');
    } else {
        tabSurah.className = `flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${inactiveTabClass}`;
        tabJuz.className = `flex-1 py-2 text-sm font-bold border-b-2 transition-colors ${activeTabClass}`;
        contentSurah.classList.add('hidden');
        contentJuz.classList.remove('hidden');
    }
}

function calculateSurahPool() {
    let start, end;
    if (filterMode === 'surah') {
        start = parseInt(startSurahSel.value);
        end = parseInt(endSurahSel.value);
    } else {
        // Juz Mapping
        const jStart = parseInt(startJuzSel.value);
        const jEnd = parseInt(endJuzSel.value);
        // Logic: Start from First surah of Start Juz, End at Last surah of End Juz
        start = juzStartSurah[Math.min(jStart, jEnd)];
        end = juzEndSurah[Math.max(jStart, jEnd)];
    }

    // Swap if start > end
    if (start > end) [start, end] = [end, start];

    activeSurahPool = [];
    for(let i = start; i <= end; i++) {
        activeSurahPool.push(i);
    }
    console.log(`Game Range: Surah ${start} to ${end}. Pool size: ${activeSurahPool.length}`);
}

async function initializeAndStart() {
    calculateSurahPool();

    startState.classList.add('hidden');
    loadingState.classList.remove('hidden');

    // Prefetch initial 2 questions
    await prefetchRandomSurah();
    await prefetchRandomSurah();
    
    setTimeout(() => {
        loadingState.classList.add('hidden');
        mainOverlay.classList.add('hidden'); 
        startGame();
    }, 800);
}

function startGame() {
    isGameActive = true;
    ropePosition = 50;
    updateRopeVisuals(); 
    
    generateQuestion('left');
    generateQuestion('right');

    if (gameMode === 'single') {
        document.getElementById('bot-overlay').classList.remove('hidden');
        startBot();
    } else {
        document.getElementById('bot-overlay').classList.add('hidden');
    }
}

function resetGame() {
    document.getElementById('winner-overlay').classList.add('hidden');
    mainOverlay.classList.remove('hidden');
    startState.classList.remove('hidden');
    loadingState.classList.add('hidden');
    clearInterval(botInterval);
    isGameActive = false;
}

// --- GAME LOGIC & VISUALS ---

function updateRopeVisuals() {
    if (ropePosition < 0) ropePosition = 0;
    if (ropePosition > 100) ropePosition = 100;

    const centerOffset = ropePosition - 50;
    const translateValue = centerOffset * 1.2; 
    
    tugContainer.style.transform = `translateX(${translateValue}%)`;

    if (ropePosition < 45) {
        // Background panel saat menang/kalah (lebih gelap)
        panelLeft.classList.add("bg-blue-300");
        panelLeft.classList.remove("bg-blue-200");
        panelRight.classList.add("opacity-70");
    } else if (ropePosition > 55) {
        panelRight.classList.add("bg-red-300");
        panelRight.classList.remove("bg-red-200");
        panelLeft.classList.add("opacity-70");
    } else {
        // Background panel normal (lebih berwarna dari sebelumnya)
        panelLeft.className = "w-[28%] md:w-[25%] border-r border-gray-200 flex flex-col h-full transition-colors duration-300 bg-blue-200 z-20 relative shadow-lg";
        panelRight.className = "w-[28%] md:w-[25%] border-l border-gray-200 flex flex-col h-full transition-colors duration-300 bg-red-200 z-20 relative shadow-lg";
    }
}

function pullRope(side) {
    const power = 5; 
    const char = side === 'left' ? charLeft : charRight;
    const anim = side === 'left' ? 'pulling-left' : 'pulling-right';

    char.classList.add(anim);
    setTimeout(() => char.classList.remove(anim), 500);

    if (side === 'left') ropePosition -= power;
    else ropePosition += power;

    updateRopeVisuals();
    checkWin();
}

function checkWin() {
    if (ropePosition <= 30) {
        endGame('TIM SANTRI (A)', 'blue');
    } else if (ropePosition >= 70) {
        endGame('TIM NASIONAL (B)', 'red');
    }
}

function endGame(name, color) {
    isGameActive = false;
    clearInterval(botInterval);
    
    const overlay = document.getElementById('winner-overlay');
    const wName = document.getElementById('winner-name');
    
    wName.innerText = name;
    wName.className = `text-4xl md:text-5xl font-black mb-10 text-center drop-shadow-lg ${color === 'blue' ? 'text-blue-400' : 'text-red-500'}`;
    
    overlay.classList.remove('hidden');
}

// --- API & SOAL ---

// Fallback jika API gagal
const fallbackData = [{surah: "Al-Ikhlas", ayat: [{nomorAyat: 1, teksArab: "ŸÇŸèŸÑŸí ŸáŸèŸàŸé Ÿ±ŸÑŸÑŸéŸëŸáŸè ÿ£Ÿéÿ≠ŸéÿØŸå"}, {nomorAyat: 2, teksArab: "Ÿ±ŸÑŸÑŸéŸëŸáŸè Ÿ±ŸÑÿµŸéŸëŸÖŸéÿØŸè"}, {nomorAyat: 3, teksArab: "ŸÑŸéŸÖŸí ŸäŸéŸÑŸêÿØŸí ŸàŸéŸÑŸéŸÖŸí ŸäŸèŸàŸÑŸéÿØŸí"}, {nomorAyat: 4, teksArab: "ŸàŸéŸÑŸéŸÖŸí ŸäŸéŸÉŸèŸÜ ŸÑŸéŸëŸáŸè€• ŸÉŸèŸÅŸèŸàŸãÿß ÿ£Ÿéÿ≠ŸéÿØŸå€¢"}]}];

async function prefetchRandomSurah() {
    // Gunakan Pool yang sudah difilter user
    if (activeSurahPool.length === 0) activeSurahPool = [112]; // Fallback Al Ikhlas

    const randomId = activeSurahPool[Math.floor(Math.random() * activeSurahPool.length)];
    
    if (cachedSurahData[randomId]) return;
    
    try {
        const response = await fetch(`https://equran.id/api/v2/surat/${randomId}`);
        if (!response.ok) throw new Error('Network error');
        const json = await response.json();
        if(json.data) cachedSurahData[randomId] = { name: json.data.namaLatin, verses: json.data.ayat };
    } catch (e) { console.error(e); }
}

async function generateQuestion(side) {
    if (!isGameActive) return;
    
    const surahIds = Object.keys(cachedSurahData);
    let selectedSurah = null;
    
    if (surahIds.length > 0) {
        // Filter pool jika ada settingan, tapi default ambil random dari yang ada
        const validPool = activeSurahPool.length > 0 
            ? activeSurahPool.filter(id => cachedSurahData[id]) 
            : surahIds.map(Number);
            
        if(validPool.length > 0) {
             const randomId = validPool[Math.floor(Math.random() * validPool.length)];
             selectedSurah = cachedSurahData[randomId];
        }
    } 
    
    if (!selectedSurah) {
        selectedSurah = { name: fallbackData[0].surah, verses: fallbackData[0].ayat };
        prefetchRandomSurah();
    }

    const maxVerseIndex = selectedSurah.verses.length - 2;
    if (maxVerseIndex < 0) return generateQuestion(side);

    const qIndex = Math.floor(Math.random() * (maxVerseIndex + 1));
    const questionVerse = selectedSurah.verses[qIndex];
    const answerVerse = selectedSurah.verses[qIndex + 1];

    // --- GENERATE 5 OPSI ---
    let options = [answerVerse.teksArab];
    let attempts = 0;
    
    // Ambil ID surah lain yang tersedia di cache untuk variasi pengecoh
    const availableCacheIds = Object.keys(cachedSurahData);

    while (options.length < 5 && attempts < 50) {
        let targetSurah = selectedSurah;

        // Logika: Jika surah ini pendek (ayat < 7) ATAU sudah mencoba 10x gagal dapat unik
        // Maka ambil pengecoh dari surah lain yang ada di cache
        if ((selectedSurah.verses.length < 7 && Math.random() > 0.4) || attempts > 10) {
            if (availableCacheIds.length > 0) {
                const rndId = availableCacheIds[Math.floor(Math.random() * availableCacheIds.length)];
                targetSurah = cachedSurahData[rndId];
            }
        }

        const rIdx = Math.floor(Math.random() * targetSurah.verses.length);
        const rVerse = targetSurah.verses[rIdx];
        
        // Validasi: Bukan jawaban benar DAN belum ada di list opsi
        // Gunakan trim() untuk memastikan tidak ada spasi yang menipu
        if (rVerse.teksArab.trim() !== answerVerse.teksArab.trim() && !options.includes(rVerse.teksArab)) {
            options.push(rVerse.teksArab);
        }
        attempts++;
    }
    
    // Fallback jika benar-benar kehabisan ide (sangat jarang terjadi dengan logika di atas)
    while(options.length < 5) options.push("..."); 
    
    options.sort(() => Math.random() - 0.5);

    const qData = { correct: answerVerse.teksArab };
    
    const surahEl = document.getElementById(`q-surah-${side}`);
    const textEl = document.getElementById(`q-text-${side}`);
    const optsEl = document.getElementById(`options-${side}`);

    surahEl.innerText = `Tebak Lanjutan Ayat`;
    surahEl.style.opacity = "1"; 
    
    textEl.innerText = questionVerse.teksArab;
    optsEl.innerHTML = '';

    options.forEach(opt => {
        const btn = document.createElement('button');
        const hoverClass = side === 'left' ? 'hover:border-blue-400 hover:bg-blue-200 bg-blue-100' : 'hover:border-red-400 hover:bg-red-200 bg-red-100';
        // Margin bottom dikurangi (mb-1) agar muat 5 tombol
        btn.className = `w-full border border-gray-200 text-slate-700 py-2 px-2 rounded-lg shadow-sm quran-font text-sm md:text-base leading-relaxed mb-1 transition-all active:scale-[0.98] hover:shadow-md break-words whitespace-normal h-auto min-h-[45px] relative overflow-hidden group ${hoverClass}`;
        btn.innerHTML = `<span class="relative z-10">${opt}</span>`;
        btn.onclick = () => handleAnswer(side, opt, qData.correct, btn);
        optsEl.appendChild(btn);
    });

    if(Math.random() > 0.6) prefetchRandomSurah();
}

function handleAnswer(side, selected, correct, btn) {
    if (!isGameActive) return;
    const buttons = btn.parentElement.querySelectorAll('button');
    buttons.forEach(b => b.disabled = true);

    if (selected === correct) {
        btn.classList.replace('bg-blue-100', 'bg-green-500');
        btn.classList.replace('bg-red-100', 'bg-green-500');
        btn.classList.replace('text-slate-700', 'text-white');
        btn.classList.replace('border-gray-200', 'border-green-600');
        pullRope(side);
        setTimeout(() => generateQuestion(side), 600);
    } else {
        btn.classList.replace('bg-blue-100', 'bg-red-500');
        btn.classList.replace('bg-red-100', 'bg-red-500');
        btn.classList.replace('text-slate-700', 'text-white');
        btn.classList.replace('border-gray-200', 'border-red-600');
        btn.classList.add('animate-[shake_0.4s_ease-in-out]');
        setTimeout(() => generateQuestion(side), 800);
    }
}

// --- BOT ---
function startBot() {
    if (botInterval) clearInterval(botInterval);
    const botAction = () => {
        if(!isGameActive) return;
        if (Math.random() < 0.65) {
            pullRope('right');
            generateQuestion('right');
        }
        if(isGameActive) setTimeout(botAction, Math.floor(Math.random() * 1500) + 2500);
    };
    setTimeout(botAction, 3000);
}
</script>
<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}
</style>
</body>
</html>
